<html>
    <head>
        <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>
    </head>

  <body>
    <div class="map">
      ══════════ Map ══════════
      <div id="position"></div>
      <div id="game"></div>
      <div id="event_result"></div>
      <div id="control">
        <button value="1">동</button>
        <button value="3">서</button>
        <button value="2">남</button>
        <button value="0">북</button>
      </div>
    </div>
    <div class="player">
      ══════════ Player ══════════
      <div class="user">
        ID: <span id="playerid"></span>
      </div>
      <div class="plv">
        LV: <span id ="lv"></span>
        EXP: <span id="exp"></span>
      </div>
      <div class="stat">
        STR: <span id="str"></span>
        DEF: <span id="def"></span>
        HP: <span id="HP"> HP / maxHP</span>
      </div>
      <div id="status">
      </div>
    </div>
    <div class="inventory">
      ════════ Inventory ══════════
      <div id ="items">
      </div>
    </div>


  <script>

const sendAction = (action, params = {}) => {
      $.ajax({
        url: "/action",
        headers: {
          Authorization: "Bearer " + key
        },
        method: "POST",
        data: `action=${action}&direction=${params.direction}`,
      }).done((req) => {
        const { player, field, event } = req;
        $('#game').text(field.description);
        $('#position').text(`(${field.x},${field.y})`);
        const x = field.x;
        const y = field.y;
        field.canGo.forEach((canGo, idx) => {
          const dom = $(`button[value="${idx}"]`);
          canGo === 0 ? dom.hide() : dom.show();
          dom.unbind('click');
          if (canGo === 1) {
            dom.bind('click', function () {
              sendAction('move', {direction: idx});
            });
          }
        })

                
        $('#playerid').text(player.name);
        $('#lv').text(player.level);
        $('#exp').text(player.exp);
        $('#str').text(player.str + "+" + player.stradd);
        $('#def').text(player.def + "+" + player.defadd);

        if (event) {
          $('#event_result').text(event.description);
        } else {
          $('#event_result').text("아무일도 일어나지 않았다.");
        }

        $('#HP').text(`${player.HP} / ${player.maxHP}`);
        
        let items = ""
        for(let i = 0; i <player.items.length; i++){
          const item = player.items[i];
          items += "\n║" + item.name + " ║ str + "+ item.str +" ║ def + "+ item.def +" ║ maxHP + "+ item.maxHP +" ║\n"
        }
        var obj = $('#items').text(items);
        obj.html(obj.html().replace(/\n/g,'<br/>'));
      });
    }
    
  
    const key = localStorage.getItem('_key');
    if (!key) {
      location.href = "/";
    }

    sendAction("query");

    

  </script>
  </body>
</html>

